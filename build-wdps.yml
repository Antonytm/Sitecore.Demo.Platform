pool:
  name: DEVDEMO1US1
  demands:
  - msbuild
  - azureps
  - Sitecore.Azure.Toolkit
steps:
- task: 4tecture.BuildVersioning.BuildVersioning.BuildVersioning@0
  displayName: 'Set Version Number'
  inputs:
    versionSource: variable
    customNumberVariable: sitecore.version
    paramOverwriteFourthDigitWithBuildCounter: true
    buildNumberAction: replace

- task: NuGetToolInstaller@1
  displayName: 'Use NuGet 4.4.1'
  inputs:
    versionSpec: 4.4.1
    checkLatest: true

- task: NuGetCommand@2
  displayName: 'NuGet restore'
  inputs:
    restoreSolution: HabitatHome.TDS.sln
    feedsToUse: config
    nugetConfigPath: 'nuget-sc-internal.config'

- task: MSBuild@1
  displayName: 'HabitatHome - CM'
  inputs:
    solution: HabitatHome.TDS.sln
    configuration: 'Package-CM'
    msbuildArguments: '/m /p:WebDeployPackageName=HabitatHome-CM-$(BuildVersion.Version) /p:PackageName=HabitatHome-CM-$(BuildVersion.Version)'

- task: MSBuild@1
  displayName: 'HabitatHome - CD'
  inputs:
    solution: HabitatHome.TDS.sln
    configuration: 'Package-CD'
    msbuildArguments: '/m /p:WebDeployPackageName=HabitatHome-CD-$(BuildVersion.Version) /p:PackageName=HabitatHome-CD-$(BuildVersion.Version)'

- task: ExtractFiles@1
  displayName: 'Extract CM WDP'
  inputs:
    archiveFilePatterns: '$(Build.SourcesDirectory)\src\Build\Build.Website\tds\master\bin\**\HabitatHome-CM*.wdp.zip'
    destinationFolder: '$(Build.ArtifactStagingDirectory)\CM-temp'
    cleanDestinationFolder: true

- task: ExtractFiles@1
  displayName: 'Extract CD WDP'
  inputs:
    archiveFilePatterns: '$(Build.SourcesDirectory)\src\Build\Build.Website\tds\master\bin\**\HabitatHome-CD*.wdp.zip'
    destinationFolder: '$(Build.ArtifactStagingDirectory)\CD-temp'
    cleanDestinationFolder: true

- task: CopyFiles@2
  displayName: 'Copy Transforms to CM'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)\src\Build\Build.Website\tds\master\bin\'
    Contents: '**\HabitatHome-CM*.sccpl'
    TargetFolder: '$(Build.ArtifactStagingDirectory)\CM-temp\Content\Website\App_Data\Transforms'
    flattenFolders: true

- task: CopyFiles@2
  displayName: 'Copy Transforms to CD'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)\src\Build\Build.Website\tds\master\bin\'
    Contents: '**\HabitatHome-CD*.sccpl'
    TargetFolder: '$(Build.ArtifactStagingDirectory)\CD-temp\Content\Website\App_Data\Transforms'
    flattenFolders: true

- task: ArchiveFiles@2
  displayName: 'Create defaults scwdp for CM'
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)\CM-temp'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/HabitatHome-CM-$(BuildVersion.Version)-defaults.scwdp.zip'
    replaceExistingArchive: true

- task: ArchiveFiles@2
  displayName: 'Create defaults scwdp for CD'
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)\CD-temp'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/HabitatHome-CD-$(BuildVersion.Version)-defaults.scwdp.zip'
    replaceExistingArchive: true

- task: DeleteFiles@1
  displayName: 'Delete temporary CM work folder'
  inputs:
    SourceFolder: '$(Build.ArtifactStagingDirectory)'
    Contents: 'CM-Temp'

- task: DeleteFiles@1
  displayName: 'Delete temporary CD work folder'
  inputs:
    SourceFolder: '$(Build.ArtifactStagingDirectory)'
    Contents: 'CD-Temp'

- task: PowerShell@2
  displayName: "Convert CM .update packge to scwdp"
  inputs:
    targetType: 'inline'
    script: |
      $sat = "c:\assets\sat\tools\Sitecore.Cloud.Cmdlets.dll"
      Import-Module $sat -Force
      
      $updatePackageSource = (Get-ChildItem "$(Build.SourcesDirectory)\src\Build\Build.Website\tds\master\bin\" -Filter HabitatHome-CM*.update).FullName
      ConvertTo-SCModuleWebDeployPackage -Path $updatePackageSource  -Destination $(Build.ArtifactStagingDirectory) -Verbose -Force

- task: CopyFiles@2
  displayName: 'Copy CM Files to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)\src\Build\Build.Website\tds\master\bin\'
    Contents: |
      **/HabitatHome-CM*.scwdp.zip
      **/HabitatHome-CM*.wdp.zip
      **/HabitatHome-CM*.update
      **/HabitatHome-CM*.sccpl
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    flattenFolders: true


- task: CopyFiles@2
  displayName: 'Copy CD Files to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)\src\Build\Build.Website\tds\master\bin\'
    Contents: |
      **/HabitatHome-CD*.scwdp.zip
      **/HabitatHome-CD*.wdp.zip
      **/HabitatHome-CD*.files.update
      **/HabitatHome-CD*.sccpl
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    flattenFolders: true

- task: PublishPipelineArtifact@0
  displayName: 'Publish Pipeline Artifact'
  inputs:
    artifactName: WDPs
    targetPath: '$(Build.ArtifactStagingDirectory)'

- task: AzureFileCopy@2
  displayName: 'AzureBlob File Copy'
  inputs:
    SourcePath: '$(Build.ArtifactStagingDirectory)'
    azureSubscription: AzureSubscription
    Destination: AzureBlob
    storage: sitecoredemopackages
    ContainerName: habitathomeplatform
    BlobPrefix: 'HabitatHome-$(BuildVersion.Version)'

